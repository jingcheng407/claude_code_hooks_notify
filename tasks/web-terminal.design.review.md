# Review: Web Terminal 设计评审

## 总体结论

- 方向正确：基于 xterm.js + node-pty + Socket.IO 的方案切中需求，落地简单、扩展性好。
- 需细化：认证/授权、会话持久化、多标签架构、文件操作安全、性能与背压、生产部署细节目前不够具体，存在安全与稳定性风险。

## 主要问题与缺口

- 认证与授权：仅提出“密码/Token”，缺少用户模型、密码存储、登录流、刷新令牌、角色（只读/可控）与暴力破解防护（限流、锁定）。
- 会话持久化：需求要求“刷新不丢失”，现用 `socket.id → pty`（易失）。缺少持久会话 ID、重连/恢复协议、过期与回收策略、跨进程存储（Redis/文件）。
- 多标签设计：前端展示单实例；未定义“标签 ID ↔ PTY”映射、同 Socket 复用 vs 多 Socket、最大标签数、内存回收。
- 文件传输安全：上传/下载端点无鉴权、无路径校验、无目录沙箱，存在路径遍历与任意读写风险；无大小/类型限制、覆盖策略、配额与审计。
- 安全默认值：CORS `*`、内联脚本、无 CSP/Helmet、无 CSRF、防火墙与 IP 白名单未细化；HTTPS 与 Cookie 安全属性未明确。
- 性能与背压：未定义 PTY→WS 背压策略、输出节流与缓冲上限；`yes`/大量输出会撑爆内存；10ms 响应目标不现实（应拆分端到端/本地渲染/网络延迟）。
- TMUX 集成：提到可恢复，但未定义何时启用、如何与每标签/多用户映射、读写权限控制、登录 shell 环境一致性。
- 跨平台细节：Windows shell（powershell/cmd）与编码、TERM/LANG 设置、登录 shell（`-l`）与 rc 文件加载未说明。
- 错误与资源回收：子进程树清理、异常保护、最大并发/每用户限额、超时与 idle 关闭、内存/CPU 上限未定义。

## 安全与隔离建议

- 最小暴露面：默认仅绑定 `127.0.0.1`，公网需显式开启并强制 HTTPS。
- 鉴权：Socket.IO 握手携带 Bearer/JWT，HTTP 端点要求同一令牌；支持只读会话共享码。
- 隔离：运行专用系统用户；限制根目录（chroot/sandbox/容器卷）；限制可写路径与命令白名单（可选）。
- 限流：`express-rate-limit` + WebSocket 消息速率限制；上传大小上限；Body 解析大小上限。
- 文件沙箱：强制在 `BASE_DIR` 内读写，路径规范化/拒绝符号链出逃；下载加入显式允许清单。
- Headers/CSP：`helmet`、严格 CSP（禁用内联脚本，移至静态文件）、`SameSite=strict`、`Secure` Cookie。

## 会话与多标签

- 模型：`userId → sessionId(cookie/JWT) → terminalId(n) → pty(pid)`；存储至 Redis（支持多进程/重启）。
- 恢复：前端刷新重连时带 `terminalId`，后端复用已有 PTY；设置 idle 与最大存活时间。
- TMUX 模式：开关化；启用时 `userId` 专属 tmux session，多客户端可只读/可写附着。

## 文件传输

- 上传：`multer` 限制大小/类型；目标路径校验 + 拒绝覆盖（或版本化）；审计日志。
- 下载：必须鉴权；仅允许 `BASE_DIR` 内；可选打包目录下载（zip）。
- 可观测性：进度回调、失败重试、断点续传（后续版）。

## 性能与稳定性

- 背压：按 Socket 缓冲长度暂停/恢复 PTY；分块/节流写入 xterm。
- 大输出：速率限制与截断策略（提示用户）；最大并发/每用户 PTY 上限。
- 指标：事件循环滞后、WS 往返、PTY 吞吐、内存水位；健康检查。

## 前端体验

- 插件：`SearchAddon/WebLinks/Unicode11/Fit`；移动端键盘与复制粘贴、Bracketed paste 支持。
- 主题：预置主题完整定义；可持久化到 `localStorage`。
- 多标签：轻量 Tab 管理器（虚拟化 DOM）、每标签独立 `terminalId` 与状态。

## 测试与验收

- 框架：单元（Jest/Vitest）、E2E（Playwright，含 WS）、安全（Supertest + 恶意用例）。
- 关键用例：刷新恢复、并发 50+ 连接、大量输出背压、路径遍历/符号链逃逸、只读共享、上传越权。
- 基准：本地回显延迟 P50/P95、最大稳定吞吐、内存泄漏巡检（长时运行）。

## 部署与运维

- 反代：Nginx/Websocket 超时、`proxy_set_header` 全量、`proxy_read_timeout` 拉长、限流与基本认证。
- Docker：非 root 用户、只读根文件系统、仅挂载受限卷；健康检查与多阶段构建。
- 配置：`.env`（端口、BASE_DIR、JWT_SECRET、CORS_ALLOWLIST、TLS 路径、限额等），文档化。

## 开放问题

- 角色：是否支持“观看/可控”两种权限？如何授予与撤销？
- 数据持久：是否需要跨重启保活（必须用 tmux）？默认策略？
- 范围限制：是否允许任意系统命令？是否需要命令审计与回放？
- 平台支持：Windows 是否一等公民？默认 shell/编码策略？
- 合规：是否需要操作日志保存/脱敏与保留周期？

## 建议的下一步

- 明确 MVP 范围与验收标准：本机单用户、JWT、会话恢复、文件在 `BASE_DIR` 内、背压、基础测试通过。
- 补全规范文档：认证流、会话/标签状态机、文件沙箱规则、性能目标与上限、部署清单。
- 落实现有样例代码的缺口：`handleData/handleResize`、鉴权中间件、CSP/Helmet、限流、沙箱校验与错误处理。
- 选定测试框架并写 8–12 个关键用例先行护栏。

