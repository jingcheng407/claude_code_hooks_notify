#!/bin/bash
#
# Claude Code Telegramä»£ç†æ¨¡å¼
# æŒç»­ç›‘å¬Telegramæ¶ˆæ¯å¹¶ä½œä¸ºClaude Codeçš„è¾“å…¥
#

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# åŠ è½½é…ç½®
CONFIG_FILE="$SCRIPT_DIR/config.sh"
if [ ! -f "$CONFIG_FILE" ]; then
    echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ config.sh ä¸å­˜åœ¨"
    echo "è¯·å…ˆé…ç½®Telegramè®¾ç½®"
    exit 1
fi
source "$CONFIG_FILE"

# æ£€æŸ¥å¿…è¦ç¯å¢ƒ
if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_USER_KEY" ]; then
    echo "é”™è¯¯ï¼šTelegramé…ç½®ä¸å®Œæ•´"
    echo "è¯·ç¡®ä¿å·²é…ç½® TELEGRAM_BOT_TOKEN å’Œ TELEGRAM_USER_KEY"
    exit 1
fi

# æ—¥å¿—æ–‡ä»¶
LOG_FILE="$SCRIPT_DIR/logs/proxy_execution.log"
mkdir -p "$(dirname "$LOG_FILE")"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1"
}

# æ¸…ç†å‡½æ•°
cleanup() {
    log "æ­£åœ¨æ¸…ç†è¿›ç¨‹å’Œæ–‡ä»¶..."
    
    # æ¸…ç†Telegramç›‘å¬å™¨è¿›ç¨‹
    if [ -n "$LISTENER_PID" ]; then
        log "åœæ­¢Telegramç›‘å¬å™¨ (PID: $LISTENER_PID)"
        kill -TERM "$LISTENER_PID" 2>/dev/null || true
        wait "$LISTENER_PID" 2>/dev/null || true
    fi
    
    # æ¸…ç†å‘½åç®¡é“
    if [ -e "$INPUT_PIPE" ]; then
        log "åˆ é™¤è¾“å…¥ç®¡é“: $INPUT_PIPE"
        rm -f "$INPUT_PIPE"
    fi
    
    # æ¸…ç†Claudeè¿›ç¨‹
    if [ -n "$CLAUDE_PID" ]; then
        log "åœæ­¢Claude Codeè¿›ç¨‹ (PID: $CLAUDE_PID)"
        kill -TERM "$CLAUDE_PID" 2>/dev/null || true
        wait "$CLAUDE_PID" 2>/dev/null || true
    fi
    
    log "æ¸…ç†å®Œæˆ"
    exit 0
}

# è®¾ç½®ä¿¡å·å¤„ç†
trap cleanup SIGTERM SIGINT EXIT

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶å’Œç®¡é“
TEMP_DIR=$(mktemp -d)
INPUT_PIPE="$TEMP_DIR/claude_input"
OUTPUT_PIPE="$TEMP_DIR/telegram_output"

log "åˆ›å»ºå‘½åç®¡é“..."
if ! mkfifo "$INPUT_PIPE"; then
    log "é”™è¯¯ï¼šæ— æ³•åˆ›å»ºè¾“å…¥ç®¡é“"
    exit 1
fi

if ! mkfifo "$OUTPUT_PIPE"; then
    log "é”™è¯¯ï¼šæ— æ³•åˆ›å»ºè¾“å‡ºç®¡é“"
    exit 1
fi

log "å¯åŠ¨ä»£ç†æ¨¡å¼..."
log "è¾“å…¥ç®¡é“: $INPUT_PIPE"
log "è¾“å‡ºç®¡é“: $OUTPUT_PIPE"

# å¯¼å‡ºç¯å¢ƒå˜é‡
export TELEGRAM_BOT_TOKEN="$TELEGRAM_BOT_TOKEN"
export TELEGRAM_USER_KEY="$TELEGRAM_USER_KEY"
export CC_HOOKS_NOTIFY="$CC_HOOKS_NOTIFY"

# å¯åŠ¨Telegramç›‘å¬å™¨ï¼ˆåå°ï¼‰
log "å¯åŠ¨Telegramç›‘å¬å™¨..."
python3 "$SCRIPT_DIR/telegram_listener.py" --output "$OUTPUT_PIPE" &
LISTENER_PID=$!
log "Telegramç›‘å¬å™¨å¯åŠ¨ (PID: $LISTENER_PID)"

# ç­‰å¾…ä¸€ä¸‹è®©ç›‘å¬å™¨åˆå§‹åŒ–
sleep 2

# å¯åŠ¨ç®¡é“è½¬å‘å™¨ï¼ˆåå°ï¼‰
log "å¯åŠ¨ç®¡é“è½¬å‘å™¨..."
(
    while IFS= read -r line; do
        echo "$line" > "$INPUT_PIPE"
    done < "$OUTPUT_PIPE"
) &
FORWARDER_PID=$!
log "ç®¡é“è½¬å‘å™¨å¯åŠ¨ (PID: $FORWARDER_PID)"

# å‘é€æ¬¢è¿æ¶ˆæ¯åˆ°Telegram
log "å‘é€å¯åŠ¨æ¶ˆæ¯åˆ°Telegram..."
python3 "$SCRIPT_DIR/telegram_bridge.py" send "ğŸš€ Claude Codeä»£ç†æ¨¡å¼å·²å¯åŠ¨

ç°åœ¨ä½ å¯ä»¥ç›´æ¥åœ¨Telegramä¸­ä¸Claude Codeå¯¹è¯ï¼š
- å‘é€ä»»ä½•æ¶ˆæ¯éƒ½ä¼šä¼ é€’ç»™Claude
- Claudeçš„å›å¤ä¼šé€šè¿‡é€šçŸ¥ç³»ç»Ÿå‘é€
- è¾“å…¥ /quit é€€å‡ºä»£ç†æ¨¡å¼

ğŸ’¡ æç¤ºï¼šä¿æŒè¿™ä¸ªç»ˆç«¯çª—å£æ‰“å¼€"

# æç¤ºç”¨æˆ·
echo "============================================="
echo "ğŸ¤– Claude Code Telegramä»£ç†æ¨¡å¼å·²å¯åŠ¨"
echo "============================================="
echo
echo "ç°åœ¨ä½ å¯ä»¥ï¼š"
echo "1. åœ¨Telegramä¸­å‘é€æ¶ˆæ¯ä¸Claudeå¯¹è¯"
echo "2. Claudeçš„å›å¤ä¼šé€šè¿‡é€šçŸ¥å‘é€åˆ°Telegram"
echo "3. å‘é€ /quit æˆ–æŒ‰ Ctrl+C é€€å‡º"
echo
echo "ä»£ç†çŠ¶æ€ï¼š"
echo "- Telegramç›‘å¬å™¨: è¿è¡Œä¸­ (PID: $LISTENER_PID)"
echo "- ç®¡é“è½¬å‘å™¨: è¿è¡Œä¸­ (PID: $FORWARDER_PID)"
echo
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo "============================================="

# å¯åŠ¨Claude Codeï¼Œä½¿ç”¨ç®¡é“ä½œä¸ºè¾“å…¥
log "å¯åŠ¨Claude Code..."

# åœ¨åå°å¯åŠ¨Claude Codeï¼Œä»ç®¡é“è¯»å–è¾“å…¥
claude code < "$INPUT_PIPE" &
CLAUDE_PID=$!
log "Claude Codeå¯åŠ¨ (PID: $CLAUDE_PID)"

# ç›‘æ§Claude Codeå’Œç›‘å¬å™¨è¿›ç¨‹
while true; do
    # æ£€æŸ¥Telegramç›‘å¬å™¨æ˜¯å¦è¿˜åœ¨è¿è¡Œ
    if ! kill -0 "$LISTENER_PID" 2>/dev/null; then
        log "Telegramç›‘å¬å™¨è¿›ç¨‹å·²é€€å‡º"
        break
    fi
    
    # æ£€æŸ¥Claude Codeæ˜¯å¦è¿˜åœ¨è¿è¡Œ
    if ! kill -0 "$CLAUDE_PID" 2>/dev/null; then
        log "Claude Codeè¿›ç¨‹å·²é€€å‡º"
        break
    fi
    
    # æ£€æŸ¥æ˜¯å¦æ”¶åˆ°é€€å‡ºå‘½ä»¤
    if [ -f "$TEMP_DIR/quit_signal" ]; then
        log "æ”¶åˆ°é€€å‡ºä¿¡å·"
        break
    fi
    
    sleep 5
done

log "ä»£ç†æ¨¡å¼é€€å‡º"